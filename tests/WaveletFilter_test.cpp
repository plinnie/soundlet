#include "gtest/gtest.h"
#include "WaveletFilter.hpp"
#include <cstdio>

const int WAVEFORM1_SIZE = 100;
const float WAVEFORM1[WAVEFORM1_SIZE] = {
     -0.011996224523, -0.006033323705, -0.015806514770, -0.031758580357, -0.033543430269,
    0.000434041023, 0.071505591273, 0.165822610259, 0.220683813095, 0.206740021706,
    0.184558734298, 0.193747192621, 0.222058892250, 0.252286732197, 0.285622388124,
    0.336207300425, 0.407882869244, 0.466948807240, 0.463527321815, 0.410794913769,
    0.359341204166, 0.316232770681, 0.283132493496, 0.291334927082, 0.306363284588,
    0.267134487629, 0.211984366179, 0.164838939905, 0.119647338986, 0.102347895503,
    0.079417362809, 0.030893648043, 0.005732741207, 0.027513124049, 0.058261036873,
    0.047087047249, 0.002130568027, -0.060481611639, -0.119728527963, -0.119465738535,
    -0.060232322663, 0.007657036185, 0.050286050886, 0.046623639762, 0.014215316623,
    0.035082202405, 0.124090261757, 0.177461043000, 0.160403266549, 0.131280601025,
    0.133906453848, 0.173402190208, 0.219346776605, 0.225852072239, 0.158123463392,
    0.072305478156, 0.058851704001, 0.106603905559, 0.171516701579, 0.222934424877,
    0.217802941799, 0.171894371510, 0.159476846457, 0.177628636360, 0.177884161472,
    0.167891323566, 0.140587687492, 0.103366181254, 0.091441780329, 0.085523061454,
    0.061669893563, 0.017477758229, -0.021719411016, -0.029382739216, -0.013328109868,
    0.016638686880, 0.016239864752, -0.038107659668, -0.090181753039, -0.100809104741,
    -0.081611812115, -0.048058714718, -0.007810667157, 0.018395826221, 0.030788999051,
    0.057594463229, 0.087374128401, 0.094941452146, 0.092986397445, 0.102674677968,
    0.125194132328, 0.150096535683, 0.152043104172, 0.123247824609, 0.112146124244,
    0.134022206068, 0.148919701576, 0.142887294292, 0.116037651896, 0.076317220926
};

const float WAVEFORM1_DB2_DETAIL[50]={
    -0.007121165804, 0.005020567377, -0.019105247446, -0.016027026345, 0.038336218780,
    -0.014084413356, -0.003400154237, -0.008732932089, 0.003360652246, 0.031901814470,
    -0.004195934620, -0.021242828243, 0.025320853824, -0.001805599901, -0.013723721215,
    0.013089274336, -0.025694271829, 0.019086240357, 0.012898824370, -0.029176477973,
    -0.011811860049, 0.025625970945, -0.022009955349, 0.008393366914, 0.014941019999,
    -0.021915346962, 0.018213172155, 0.018343072054, -0.038924834337, 0.004296875299,
    0.027011826627, -0.019097905578, 0.007265526340, 0.007030145592, -0.006174208019,
    0.012143855451, -0.015876071910, -0.009788390458, 0.029984822660, -0.020311442724,
    -0.010792914275, 0.005915159609, -0.005173026998, 0.010342847193, -0.004391012650,
    -0.002811352068, 0.017817876120, -0.018216763392, 0.011011462347, 0.008910062001
};

const float WAVEFORM1_DB2_APPROX[50]={
    -0.001908110626, -0.010273775827, -0.041775253921, -0.021268635414, 0.195958661658,
    0.295818472942, 0.268332542876, 0.338800254838, 0.450184730688, 0.638338622216,
    0.607123744106, 0.463843241673, 0.414548615350, 0.397607725886, 0.253844472822,
    0.157203893275, 0.061923179708, 0.032749220085, 0.075831453054, -0.060941280059,
    -0.172251075854, -0.017446975419, 0.061934037417, 0.041061227421, 0.227344498771,
    0.194861607889, 0.229663436367, 0.320950686186, 0.136248167898, 0.127193674892,
    0.295898912221, 0.261742107756, 0.243755560662, 0.244490582156, 0.163794750772,
    0.127265564000, 0.043338834616, -0.040209429043, 0.016053110225, -0.031202455060,
    -0.139956433760, -0.083748685161, 0.011064039343, 0.070346699285, 0.129173785951,
    0.139435599551, 0.204152409431, 0.184323111576, 0.181162640707, 0.207583197183
};

void printArray(const char * name, const float * values, unsigned int length)
{
    printf("Array %s:\n    ", name);
    for (int i = 0; i < length; i++)
    {
        printf("%1.12f, ", values[i]);
        if (i % 5 == 4 && i != length - 1) printf("\n    ");
    }
    puts("");
}

bool arrays_equal(const float * was, const float * exp, unsigned int len)
{
    const float treshold = 1.0f/(1 << 12);
    int errs = 0;
    for (int i = 0; i < len; ++i)
    {
        if (abs(was[i] - exp[i]) > treshold) {
            printf("[%d] was=%f, exp=%f\n", i, was[i], exp[i]);
            errs++;
            if (errs > 10) return false;
        }
    }
    return errs == 0;
}

TEST(WaveletFilter, testInput) {
    FilterBank fb;
    unsigned int size_out;
    unsigned int rc_size_out;
    float reconstruct[WAVEFORM1_SIZE];
    float detail[WAVEFORM1_SIZE>>1];
    float approx[WAVEFORM1_SIZE>>1];
    fb.config(&db2_coeffs);
    fb.decompose(WAVEFORM1, WAVEFORM1_SIZE, detail, approx, size_out);
    // printArray("detail", detail, size_out);
    // printArray("approx", approx, size_out);

    ASSERT_TRUE(arrays_equal(detail, WAVEFORM1_DB2_DETAIL, size_out));
    ASSERT_TRUE(arrays_equal(approx, WAVEFORM1_DB2_APPROX, size_out));

    fb.reconstruct(detail, approx, size_out, reconstruct, &rc_size_out);

    ASSERT_EQ(rc_size_out, WAVEFORM1_SIZE-2);

    ASSERT_TRUE(arrays_equal(reconstruct, WAVEFORM1, rc_size_out));

}

