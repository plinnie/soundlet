#include <catch2/catch_test_macros.hpp>
#include "WaveletFilter.hpp"
#include <cstdio>
#include <cmath>

const int WAVEFORM1_SIZE = 100;
const float WAVEFORM1[WAVEFORM1_SIZE] = {
     -0.011996224523f, -0.006033323705f, -0.015806514770f, -0.031758580357f, -0.033543430269f,
      0.000434041023f,  0.071505591273f,  0.165822610259f,  0.220683813095f,  0.206740021706f,
      0.184558734298f,  0.193747192621f,  0.222058892250f,  0.252286732197f,  0.285622388124f,
      0.336207300425f,  0.407882869244f,  0.466948807240f,  0.463527321815f,  0.410794913769f,
      0.359341204166f,  0.316232770681f,  0.283132493496f,  0.291334927082f,  0.306363284588f,
      0.267134487629f,  0.211984366179f,  0.164838939905f,  0.119647338986f,  0.102347895503f,
      0.079417362809f,  0.030893648043f,  0.005732741207f,  0.027513124049f,  0.058261036873f,
      0.047087047249f,  0.002130568027f, -0.060481611639f, -0.119728527963f, -0.119465738535f,
     -0.060232322663f,  0.007657036185f,  0.050286050886f,  0.046623639762f,  0.014215316623f,
      0.035082202405f,  0.124090261757f,  0.177461043000f,  0.160403266549f,  0.131280601025f,
      0.133906453848f,  0.173402190208f,  0.219346776605f,  0.225852072239f,  0.158123463392f,
      0.072305478156f,  0.058851704001f,  0.106603905559f,  0.171516701579f,  0.222934424877f,
      0.217802941799f,  0.171894371510f,  0.159476846457f,  0.177628636360f,  0.177884161472f,
      0.167891323566f,  0.140587687492f,  0.103366181254f,  0.091441780329f,  0.085523061454f,
      0.061669893563f,  0.017477758229f, -0.021719411016f, -0.029382739216f, -0.013328109868f,
      0.016638686880f,  0.016239864752f, -0.038107659668f, -0.090181753039f, -0.100809104741f,
     -0.081611812115f, -0.048058714718f, -0.007810667157f,  0.018395826221f,  0.030788999051f,
      0.057594463229f,  0.087374128401f,  0.094941452146f,  0.092986397445f,  0.102674677968f,
      0.125194132328f,  0.150096535683f,  0.152043104172f,  0.123247824609f,  0.112146124244f,
      0.134022206068f,  0.148919701576f,  0.142887294292f,  0.116037651896f,  0.076317220926f
};

const float WAVEFORM1_DB2_DETAIL[50] = {
    -0.007121165804f,  0.005020567377f, -0.019105247446f, -0.016027026345f,  0.038336218780f,
    -0.014084413356f, -0.003400154237f, -0.008732932089f,  0.003360652246f,  0.031901814470f,
    -0.004195934620f, -0.021242828243f,  0.025320853824f, -0.001805599901f, -0.013723721215f,
     0.013089274336f, -0.025694271829f,  0.019086240357f,  0.012898824370f, -0.029176477973f,
    -0.011811860049f,  0.025625970945f, -0.022009955349f,  0.008393366914f,  0.014941019999f,
    -0.021915346962f,  0.018213172155f,  0.018343072054f, -0.038924834337f,  0.004296875299f,
     0.027011826627f, -0.019097905578f,  0.007265526340f,  0.007030145592f, -0.006174208019f,
     0.012143855451f, -0.015876071910f, -0.009788390458f,  0.029984822660f, -0.020311442724f,
    -0.010792914275f,  0.005915159609f, -0.005173026998f,  0.010342847193f, -0.004391012650f,
    -0.002811352068f,  0.017817876120f, -0.018216763392f,  0.011011462347f,  0.008910062001f
};

const float WAVEFORM1_DB2_APPROX[50] = {
    -0.001908110626f, -0.010273775827f, -0.041775253921f, -0.021268635414f,  0.195958661658f,
     0.295818472942f,  0.268332542876f,  0.338800254838f,  0.450184730688f,  0.638338622216f,
     0.607123744106f,  0.463843241673f,  0.414548615350f,  0.397607725886f,  0.253844472822f,
     0.157203893275f,  0.061923179708f,  0.032749220085f,  0.075831453054f, -0.060941280059f,
    -0.172251075854f, -0.017446975419f,  0.061934037417f,  0.041061227421f,  0.227344498771f,
     0.194861607889f,  0.229663436367f,  0.320950686186f,  0.136248167898f,  0.127193674892f,
     0.295898912221f,  0.261742107756f,  0.243755560662f,  0.244490582156f,  0.163794750772f,
     0.127265564000f,  0.043338834616f, -0.040209429043f,  0.016053110225f, -0.031202455060f,
    -0.139956433760f, -0.083748685161f,  0.011064039343f,  0.070346699285f,  0.129173785951f,
     0.139435599551f,  0.204152409431f,  0.184323111576f,  0.181162640707f,  0.207583197183f
};

bool arrays_equal(const float* was, const float* exp, unsigned int len)
{
    const float threshold = 1.0f / (1 << 12);
    int errs = 0;

    for (unsigned int i = 0; i < len; ++i)
    {
        if (std::fabs(was[i] - exp[i]) > threshold)
        {
            std::printf("[%u] was=%f, exp=%f\n", i, was[i], exp[i]);
            if (++errs > 10)
                return false;
        }
    }
    return errs == 0;
}

TEST_CASE("WaveletFilter input / reconstruct (db2)", "[WaveletFilter]")
{
    FilterBank fb;

    unsigned int size_out = 0;
    unsigned int rc_size_out = 0;

    float reconstruct[WAVEFORM1_SIZE];
    float detail[WAVEFORM1_SIZE >> 1];
    float approx[WAVEFORM1_SIZE >> 1];

    fb.config(&db2_coeffs);
    fb.decompose(WAVEFORM1, WAVEFORM1_SIZE, detail, approx, size_out);

    REQUIRE(arrays_equal(detail, WAVEFORM1_DB2_DETAIL, size_out));
    REQUIRE(arrays_equal(approx, WAVEFORM1_DB2_APPROX, size_out));

    fb.reconstruct(detail, approx, size_out, reconstruct, &rc_size_out);

    REQUIRE(rc_size_out == WAVEFORM1_SIZE - 2);
    REQUIRE(arrays_equal(reconstruct, WAVEFORM1, rc_size_out));
}
